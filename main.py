import streamlit as st
import os
from google import genai
from PIL import Image
from dotenv import load_dotenv

# --- 1. SETUP AI & CONFIG ---
load_dotenv()

client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

st.set_page_config(page_title="AI Face Analyst", layout="centered", page_icon="üë§")

st.title("üë§ AI Age & Emotion Guesser")
st.markdown("‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏™‡∏î‡πÜ!")

# Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
with st.sidebar:
    st.header("System Status")
    st.info("Model: Gemini 2.5 Flash")
    st.warning("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")

# --- 2. CAMERA INPUT ---
# ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á Streamlit
img_file = st.camera_input("‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡πâ‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢!")

if img_file is not None:
    raw_image = Image.open(img_file)
    image = raw_image.transpose(Image.Transpose.FLIP_LEFT_RIGHT)

    # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    with st.spinner('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...'):
        try:
            # --- 3. PROMPT DESIGN ---
            prompt = """
            ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û (Expert Face & Character Analyst)
            ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
            1. ‡∏ó‡∏≤‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏ (Age): ‡∏ö‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô 18‡∏õ‡∏µ, 20‡∏õ‡∏µ, 30‡∏õ‡∏µ)
            2. ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå (Emotion): ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç, ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á, ‡∏á‡πà‡∏ß‡∏á‡∏ô‡∏≠‡∏ô)
            3. ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏î‡πà‡∏ô (Features): ‡∏ó‡∏±‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ß‡πà‡∏ô‡∏ï‡∏≤‡πÄ‡∏ó‡πà‡∏°‡∏≤‡∏Å, ‡∏¢‡∏¥‡πâ‡∏°‡∏™‡∏ß‡∏¢)
            4. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏ß‡∏ô‡πÜ (Advice): ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó
            
            ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏ï‡∏•‡∏Å‡πÜ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏™
            """

            # --- 4. CALL GEMINI API ---
            response = client.models.generate_content(
                model="gemini-2.5-flash-lite",
                contents=[prompt, image]
            )

            # --- 5. DISPLAY RESULT ---
            st.subheader("üîç ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI")
            st.write(response.text)

        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
            st.info("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå .env ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ä‡∏∑‡πà‡∏≠ gemini-2.5-flash ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á")

# ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.divider()
st.caption("Project 4: Multimodal AI")
